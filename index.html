<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>åˆ†é… forest.mushroom.box</title>
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.11.1/ethers.umd.min.js"
        integrity="sha384-POWgdAoUVoSKkKYCBiE8vhaiaawRSqMLmzJK50pZmRICRfkn2pYEHFRmn7Bogvej"
        crossorigin="anonymous"
        referrerpolicy="no-referrer"
    ></script>
    <style>
        body { font-family: monospace; padding: 40px; max-width: 600px; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; margin-top: 10px; }
        input { padding: 10px; font-size: 16px; width: 100%; margin-top: 10px; margin-bottom: 20px;}
        #log { margin-top: 20px; padding: 10px; background: #f4f4f4; border-radius: 5px; white-space: pre-wrap; word-wrap: break-word;}
    </style>
</head>
<body>

    <h2>ğŸ„ è˜‘è‡æ£®æ— - å­åŸŸååˆ†é…å™¨</h2>
    <p>å½“å‰æ“ä½œï¼šå°† <b>forest.mushroom.box</b> åˆ†é…ç»™æŒ‡å®šçš„ Controller åœ°å€ã€‚</p>

    <label>è¯·è¾“å…¥ç›®æ ‡ Controller åœ°å€ (EOA):</label>
    <input type="text" id="targetAddress" placeholder="0x..." />

    <button id="actionBtn" onclick="execute()">1. è¿æ¥ MetaMask å¹¶æ‰§è¡Œ</button>

    <div id="log">ç­‰å¾…æ“ä½œ...</div>

    <script>
        const logEl = document.getElementById('log');
        function resetLog() {
            logEl.textContent = "";
        }

        function logText(msg) {
            console.log(msg);
            const line = document.createElement('div');
            line.textContent = msg;
            logEl.appendChild(line);
        }

        function logLink(label, url) {
            console.log(label, url);
            const line = document.createElement('div');
            const a = document.createElement('a');
            a.href = url;
            a.target = "_blank";
            a.rel = "noopener noreferrer";
            a.textContent = label;
            line.appendChild(a);
            logEl.appendChild(line);
        }

        async function execute() {
            resetLog();

            const rawTargetAddress = document.getElementById('targetAddress').value.trim();
            if (!rawTargetAddress || !ethers.isAddress(rawTargetAddress)) {
                alert("è¯·è¾“å…¥åˆæ³•çš„ä»¥å¤ªåŠåœ°å€ï¼");
                return;
            }
            const targetAddress = ethers.getAddress(rawTargetAddress);

            // 1. æ£€æŸ¥æ˜¯å¦å®‰è£…äº† MetaMask
            if (typeof window.ethereum === 'undefined') {
                logText("âŒ æœªæ£€æµ‹åˆ° MetaMaskï¼Œè¯·å®‰è£…æ’ä»¶ã€‚");
                return;
            }

            const actionBtn = document.getElementById('actionBtn');
            actionBtn.disabled = true;

            try {
                // 2. åˆå§‹åŒ– Ethers Provider (é€šè¿‡ MetaMask)
                const provider = new ethers.BrowserProvider(window.ethereum);
                
                // è¯·æ±‚ç”¨æˆ·è¿æ¥é’±åŒ…
                logText("æ­£åœ¨è¯·æ±‚è¿æ¥ MetaMask...");
                await provider.send("eth_requestAccounts", []);
                const signer = await provider.getSigner();
                const signerAddress = await signer.getAddress();
                logText("âœ… é’±åŒ…å·²è¿æ¥: " + signerAddress);

                // 3. æ£€æŸ¥å¹¶åˆ‡æ¢åˆ°ä»¥å¤ªåŠä¸»ç½‘ (Chain ID: 1)
                let network = await provider.getNetwork();
                if (network.chainId !== 1n) {
                    logText("âš ï¸ å½“å‰ä¸åœ¨ä»¥å¤ªåŠä¸»ç½‘ï¼Œè¯·æ±‚åˆ‡æ¢ç½‘ç»œ...");
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0x1' }],
                        });
                        network = await provider.getNetwork();
                        if (network.chainId !== 1n) {
                            logText("âŒ æœªèƒ½åˆ‡æ¢åˆ°ä»¥å¤ªåŠä¸»ç½‘ï¼Œè¯·åœ¨ MetaMask ä¸­ç¡®è®¤ç½‘ç»œã€‚");
                            return;
                        }
                        logText("âœ… å·²åˆ‡æ¢åˆ°ä»¥å¤ªåŠä¸»ç½‘ã€‚");
                    } catch (switchError) {
                        logText("âŒ åˆ‡æ¢ç½‘ç»œå¤±è´¥ï¼Œè¯·æ‰‹åŠ¨åœ¨ MetaMask ä¸­åˆ‡æ¢åˆ°ä»¥å¤ªåŠä¸»ç½‘ã€‚");
                        return;
                    }
                }

                // 4. è®¾ç½®åˆçº¦ä¿¡æ¯
                const ENS_REGISTRY_ADDRESS = "0x00000000000C2E074eC69A0dFb2997BA6C7d2e1e";
                const ENS_REGISTRY_ABI = [
                    "function owner(bytes32 node) external view returns(address)",
                    "function isApprovedForAll(address owner, address operator) external view returns(bool)",
                    "function setSubnodeOwner(bytes32 node, bytes32 label, address owner) external returns(bytes32)"
                ];
                // æ³¨æ„ï¼šè¿™é‡Œä¼ å…¥çš„æ˜¯ signerï¼Œè€Œä¸æ˜¯ providerï¼Œè¿™æ ·æ‰èƒ½å‘èµ·å†™æ“ä½œ
                const registry = new ethers.Contract(ENS_REGISTRY_ADDRESS, ENS_REGISTRY_ABI, signer);

                // 5. è®¡ç®—å“ˆå¸Œå€¼
                const parentNode = ethers.namehash("mushroom.box");
                const childLabel = ethers.id("forest"); // å¯¹ "forest" è¿›è¡Œ keccak256
                
                const parentOwner = await registry.owner(parentNode);
                const isOperator = await registry.isApprovedForAll(parentOwner, signerAddress);
                if (parentOwner.toLowerCase() !== signerAddress.toLowerCase() && !isOperator) {
                    logText("âŒ å½“å‰è¿æ¥çš„é’±åŒ…æ— æƒä¿®æ”¹ mushroom.box çš„å­åŸŸåã€‚");
                    logText("éœ€è¦æ»¡è¶³å…¶ä¸€ï¼š");
                    logText(" - è¿æ¥é’±åŒ…æ˜¯ mushroom.box çš„ owner");
                    logText(" - mushroom.box çš„ owner å·²å¯¹è¯¥é’±åŒ…è®¾ç½® ApprovalForAll");
                    logText("å½“å‰æŸ¥è¯¢åˆ°çš„ owner: " + parentOwner);
                    return;
                }

                logText("â³ æ­£åœ¨å”¤èµ· MetaMask å‘èµ·äº¤æ˜“...");
                logText("å‚æ•°:");
                logText(" - Parent: mushroom.box");
                logText(" - Label: forest");
                logText(" - New Owner: " + targetAddress);

                // 6. å‘èµ·äº¤æ˜“
                const tx = await registry.setSubnodeOwner(parentNode, childLabel, targetAddress);
                logText("ğŸš€ äº¤æ˜“å·²æäº¤! Hash:");
                logLink(tx.hash, `https://etherscan.io/tx/${tx.hash}`);
                logText("â³ ç­‰å¾…åŒºå—é“¾ç¡®è®¤...");

                // 7. ç­‰å¾…å‡ºå—
                await tx.wait();
                logText("ğŸ‰ æˆåŠŸï¼forest.mushroom.box çš„æ‰€æœ‰æƒå·²è½¬ç§»ç»™ç›®æ ‡åœ°å€ï¼");

            } catch (error) {
                logText("âŒ å‘ç”Ÿé”™è¯¯:");
                logText(error?.message || String(error));
            } finally {
                actionBtn.disabled = false;
            }
        }
    </script>
</body>
</html>
